{% comment %}
  LatentSEO - Automatic JSON-LD Schema Injection
  Company: Nimbiclabs
  This block injects Google-compliant structured data into the <head>
{% endcomment %}

{%- if block.settings.enable_schema -%}

{%- comment -%} Breadcrumb Schema {%- endcomment -%}
{%- if block.settings.enable_breadcrumbs and request.page_type != 'index' -%}
{%- capture breadcrumb_items -%}
{
  "@type": "ListItem",
  "position": 1,
  "name": "Home",
  "item": "{{ shop.url }}"
}
{%- case request.page_type -%}
  {%- when 'product' -%}
    {%- if product.collections.size > 0 -%}
,{
  "@type": "ListItem",
  "position": 2,
  "name": {{ product.collections.first.title | json }},
  "item": "{{ shop.url }}{{ product.collections.first.url }}"
},
{
  "@type": "ListItem",
  "position": 3,
  "name": {{ product.title | json }},
  "item": "{{ shop.url }}{{ product.url }}"
}
    {%- else -%}
,{
  "@type": "ListItem",
  "position": 2,
  "name": {{ product.title | json }},
  "item": "{{ shop.url }}{{ product.url }}"
}
    {%- endif -%}
  {%- when 'collection' -%}
,{
  "@type": "ListItem",
  "position": 2,
  "name": {{ collection.title | json }},
  "item": "{{ shop.url }}{{ collection.url }}"
}
  {%- when 'article' -%}
,{
  "@type": "ListItem",
  "position": 2,
  "name": {{ blog.title | json }},
  "item": "{{ shop.url }}{{ blog.url }}"
},
{
  "@type": "ListItem",
  "position": 3,
  "name": {{ article.title | json }},
  "item": "{{ shop.url }}{{ article.url }}"
}
  {%- when 'blog' -%}
,{
  "@type": "ListItem",
  "position": 2,
  "name": {{ blog.title | json }},
  "item": "{{ shop.url }}{{ blog.url }}"
}
  {%- when 'page' -%}
,{
  "@type": "ListItem",
  "position": 2,
  "name": {{ page.title | json }},
  "item": "{{ shop.url }}{{ page.url }}"
}
{%- endcase -%}
{%- endcapture -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{{ breadcrumb_items }}]
}
</script>
{%- endif -%}

{%- comment -%} Product Schema {%- endcomment -%}
{%- if request.page_type == 'product' and block.settings.enable_product_schema -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Product",
  "name": {{ product.title | json }},
  "description": {{ product.description | strip_html | truncatewords: 50 | json }},
  "brand": {
    "@type": "Brand",
    "name": {{ product.vendor | json }}
  },
  {%- if product.featured_image -%}
  "image": {{ product.featured_image | image_url: width: 1200 | json }},
  {%- endif -%}
  "sku": {{ product.selected_or_first_available_variant.sku | default: product.id | json }},
  "offers": {
    "@type": "Offer",
    "priceCurrency": {{ cart.currency.iso_code | json }},
    "price": {{ product.selected_or_first_available_variant.price | divided_by: 100.00 }},
    "availability": "https://schema.org/{% if product.available %}InStock{% else %}OutOfStock{% endif %}",
    "url": "{{ shop.url }}{{ product.url }}",
    "seller": {
      "@type": "Organization",
      "name": {{ shop.name | json }}
    }
  }
  {%- if product.metafields.reviews.rating.value != blank -%}
  ,"aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": {{ product.metafields.reviews.rating.value | json }},
    "reviewCount": {{ product.metafields.reviews.rating_count.value | default: 1 }}
  }
  {%- endif -%}
}
</script>
{%- endif -%}

{%- comment -%} Collection Schema {%- endcomment -%}
{%- if request.page_type == 'collection' and block.settings.enable_collection_schema -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": {{ collection.title | json }},
  "description": {{ collection.description | strip_html | truncatewords: 50 | default: collection.title | json }},
  "url": "{{ shop.url }}{{ collection.url }}",
  "numberOfItems": {{ collection.products_count }}
}
</script>
{%- endif -%}

{%- comment -%} Article Schema {%- endcomment -%}
{%- if request.page_type == 'article' and block.settings.enable_article_schema -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": {{ article.title | json }},
  "description": {{ article.excerpt | strip_html | truncatewords: 50 | default: article.title | json }},
  {%- if article.image -%}
  "image": {{ article.image | image_url: width: 1200 | json }},
  {%- endif -%}
  "datePublished": "{{ article.published_at | date: '%Y-%m-%dT%H:%M:%S%z' }}",
  "dateModified": "{{ article.updated_at | date: '%Y-%m-%dT%H:%M:%S%z' }}",
  "author": {
    "@type": "Person",
    "name": {{ article.author | json }}
  },
  "publisher": {
    "@type": "Organization",
    "name": {{ shop.name | json }}
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{ shop.url }}{{ article.url }}"
  }
}
</script>
{%- endif -%}

{%- comment -%} Blog Schema {%- endcomment -%}
{%- if request.page_type == 'blog' and block.settings.enable_blog_schema -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Blog",
  "name": {{ blog.title | json }},
  "description": {{ blog.title | append: ' - ' | append: shop.name | json }},
  "url": "{{ shop.url }}{{ blog.url }}"
}
</script>
{%- endif -%}

{%- comment -%} Organization Schema (Homepage) {%- endcomment -%}
{%- if request.page_type == 'index' and block.settings.enable_organization_schema -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": {{ shop.name | json }},
  "url": {{ shop.url | json }}
  {%- if block.settings.organization_logo != blank -%}
  ,"logo": {{ block.settings.organization_logo | image_url: width: 600 | json }}
  {%- endif -%}
  ,"contactPoint": {
    "@type": "ContactPoint",
    "contactType": "customer service",
    "email": {{ shop.email | json }}
  }
  {%- if block.settings.social_facebook != blank or block.settings.social_twitter != blank or block.settings.social_instagram != blank -%}
  ,"sameAs": [
    {%- assign social_links = "" -%}
    {%- if block.settings.social_facebook != blank -%}
      {%- assign social_links = social_links | append: block.settings.social_facebook | append: "|||" -%}
    {%- endif -%}
    {%- if block.settings.social_twitter != blank -%}
      {%- assign social_links = social_links | append: block.settings.social_twitter | append: "|||" -%}
    {%- endif -%}
    {%- if block.settings.social_instagram != blank -%}
      {%- assign social_links = social_links | append: block.settings.social_instagram | append: "|||" -%}
    {%- endif -%}
    {%- assign social_array = social_links | split: "|||" -%}
    {%- for link in social_array -%}
      {%- if link != "" -%}
        {{ link | json }}{%- unless forloop.last -%},{%- endunless -%}
      {%- endif -%}
    {%- endfor -%}
  ]
  {%- endif -%}
}
</script>
{%- endif -%}

{%- comment -%} WebSite Schema (Homepage fallback or other pages) {%- endcomment -%}
{%- if request.page_type == 'index' and block.settings.enable_organization_schema == false -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": {{ shop.name | json }},
  "url": {{ shop.url | json }}
}
</script>
{%- endif -%}

{%- comment -%} WebPage Schema (Generic pages) {%- endcomment -%}
{%- if request.page_type == 'page' -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": {{ page.title | json }},
  "description": {{ page.content | strip_html | truncatewords: 50 | json }},
  "url": "{{ shop.url }}{{ page.url }}"
}
</script>
{%- endif -%}

{%- endif -%}

{% schema %}
{
  "name": "LatentSEO Schema",
  "target": "head",
  "settings": [
    {
      "type": "header",
      "content": "LatentSEO - Automatic Schema"
    },
    {
      "type": "paragraph",
      "content": "Automatically inject Google-compliant JSON-LD structured data for better SEO and rich results."
    },
    {
      "type": "checkbox",
      "id": "enable_schema",
      "label": "Enable Schema Injection",
      "default": true,
      "info": "Master toggle for all schema types"
    },
    {
      "type": "header",
      "content": "Schema Types"
    },
    {
      "type": "checkbox",
      "id": "enable_product_schema",
      "label": "Product Schema",
      "default": true,
      "info": "Rich product data for Google Shopping"
    },
    {
      "type": "checkbox",
      "id": "enable_collection_schema",
      "label": "Collection Schema",
      "default": true,
      "info": "Collection page structured data"
    },
    {
      "type": "checkbox",
      "id": "enable_article_schema",
      "label": "Article Schema",
      "default": true,
      "info": "Blog article structured data"
    },
    {
      "type": "checkbox",
      "id": "enable_blog_schema",
      "label": "Blog Schema",
      "default": true,
      "info": "Blog listing page structured data"
    },
    {
      "type": "checkbox",
      "id": "enable_organization_schema",
      "label": "Organization Schema",
      "default": true,
      "info": "Business info on homepage"
    },
    {
      "type": "checkbox",
      "id": "enable_breadcrumbs",
      "label": "Breadcrumb Schema",
      "default": true,
      "info": "Navigation path for Google"
    },
    {
      "type": "header",
      "content": "Organization Details"
    },
    {
      "type": "image_picker",
      "id": "organization_logo",
      "label": "Business Logo",
      "info": "Logo for Organization schema (recommended 600px wide)"
    },
    {
      "type": "header",
      "content": "Social Profiles"
    },
    {
      "type": "url",
      "id": "social_facebook",
      "label": "Facebook URL"
    },
    {
      "type": "url",
      "id": "social_twitter",
      "label": "Twitter/X URL"
    },
    {
      "type": "url",
      "id": "social_instagram",
      "label": "Instagram URL"
    }
  ]
}
{% endschema %}
